<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chinfield - Demo RAG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
        }

        #chinfield-iframe {
            width: 100%;
            height: 100vh;
            border: none;
        }

        /* ============================================ */
        /* CHAT WIDGET - MOBILE FIRST (fullscreen)     */
        /* ============================================ */
        .chat-widget {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh; /* iOS Safari fix */
            background: #ffffff;
            border-radius: 0;
            box-shadow: none;
            display: none;
            flex-direction: column;
            z-index: 10000;
            animation: slideUpFull 0.3s ease-out;
        }

        .chat-widget.open {
            display: flex;
        }

        @keyframes slideUpFull {
            from {
                opacity: 0;
                transform: translateY(100%);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Header */
        .chat-header {
            background: linear-gradient(135deg, #C8102E 0%, #A00D24 100%);
            color: #ffffff;
            padding: 16px 20px;
            padding-top: calc(16px + env(safe-area-inset-top, 0px));
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .chat-header-info h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .chat-status {
            font-size: 12px;
            opacity: 0.95;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #ffffff;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .chat-close:active {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Messages */
        .chat-messages {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
        }

        .message {
            padding: 12px 16px;
            border-radius: 14px;
            max-width: 85%;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }

        .message.user {
            background: linear-gradient(135deg, #C8102E 0%, #A00D24 100%);
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.bot {
            background: #f3f4f6;
            color: #111827;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }

        .message.bot strong {
            color: #C8102E;
        }

        .message.welcome {
            background: #f3f4f6;
            padding: 16px;
            max-width: 100%;
        }

        .message.welcome ul {
            margin-top: 12px;
            margin-left: 20px;
        }

        .message.welcome li {
            margin-bottom: 6px;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: #f3f4f6;
            border-radius: 14px;
            width: fit-content;
            border-bottom-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9ca3af;
            animation: typingBounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.7; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Input Container */
        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 12px 16px;
            padding-bottom: calc(12px + env(safe-area-inset-bottom, 8px));
            border-top: 1px solid #e5e7eb;
            background: white;
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 24px;
            font-size: 16px; /* Previene zoom en iOS */
            outline: none;
            font-family: inherit;
            -webkit-appearance: none;
        }

        .chat-input:focus {
            border-color: #C8102E;
        }

        .chat-send {
            width: 48px;
            height: 48px;
            min-width: 48px;
            background: linear-gradient(135deg, #C8102E 0%, #A00D24 100%);
            border: none;
            border-radius: 50%;
            color: #ffffff;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
        }

        .chat-send:active {
            transform: scale(0.95);
        }

        .chat-send:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        /* Chat Button */
        .chat-button-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-tooltip {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            color: #1d1d1f;
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08),
                        0 8px 24px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
            opacity: 0;
            transform: translateX(10px);
            transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
            pointer-events: none;
            letter-spacing: -0.01em;
        }

        .chat-tooltip.visible {
            opacity: 1;
            transform: translateX(0);
        }

        .chat-tooltip::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            border: 6px solid transparent;
            border-left-color: #ffffff;
        }

        .chat-button {
            width: 72px;
            height: 72px;
            background: #ffffff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08), 
                        0 8px 24px rgba(0, 0, 0, 0.12);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            flex-shrink: 0;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
            overflow: hidden;
            padding: 12px;
        }

        .chat-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1), 
                        0 12px 32px rgba(0, 0, 0, 0.15);
        }

        .chat-button:active {
            transform: scale(0.98);
            transition: all 0.1s ease;
        }

        /* AnimaciÃ³n suave de breathing */
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        .chat-button:hover .chinfield-logo {
            animation: breathe 2s ease-in-out infinite;
        }

        .chinfield-logo {
            width: 48px;
            height: 48px;
        }

        .chat-button-badge {
            position: absolute;
            top: 2px;
            right: 2px;
            background: #005DAA;
            color: #ffffff;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .chat-button:active {
            transform: scale(0.95);
        }

        .chat-button-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #005DAA;
            color: #ffffff;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        /* Demo Banner */
        .demo-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #005DAA 0%, #003d73 100%);
            color: white;
            padding: 10px 24px;
            text-align: center;
            font-size: 13px;
            z-index: 9998;
        }

        /* ============================================ */
        /* DESKTOP (â‰¥768px) - Widget flotante          */
        /* ============================================ */
        @media (min-width: 768px) {
            .chat-widget {
                top: auto;
                left: auto;
                bottom: 100px;
                right: 24px;
                width: 400px;
                height: 600px;
                max-height: 600px;
                border-radius: 16px;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.2);
                animation: slideUp 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            }

            @keyframes slideUp {
                from { opacity: 0; transform: translateY(30px) scale(0.9); }
                to { opacity: 1; transform: translateY(0) scale(1); }
            }

            .chat-header {
                padding: 20px;
                border-radius: 16px 16px 0 0;
            }

            .chat-close {
                width: 32px;
                height: 32px;
                font-size: 18px;
            }

            .chat-close:hover {
                background: rgba(255, 255, 255, 0.3);
                transform: rotate(90deg);
            }

            .chat-messages {
                padding: 20px;
                max-height: 420px;
            }

            .message {
                font-size: 14px;
            }

            .chat-input-container {
                padding: 16px;
                border-radius: 0 0 16px 16px;
            }

            .chat-input {
                padding: 12px 16px;
                font-size: 14px;
            }

            .chat-send {
                width: 44px;
                height: 44px;
                min-width: 44px;
                font-size: 18px;
            }

            .chat-button:hover {
                transform: scale(1.08);
            }

            .chat-button {
                width: 68px;
                height: 68px;
                padding: 10px;
            }

            .chinfield-logo {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- Demo Banner -->
    <div class="demo-banner">
        <strong>DEMO TÃ‰CNICA</strong> - Asistente Virtual RAG para Chinfield
    </div>

    <!-- Chinfield Website Iframe -->
    <iframe 
        id="chinfield-iframe" 
        src="https://chinfield.com"
        title="Chinfield Website"
        style="margin-top: 40px; height: calc(100vh - 40px);">
    </iframe>

    <!-- Chat Widget -->
    <div id="chatWidget" class="chat-widget">
        <div class="chat-header">
            <div class="chat-header-info">
                <h3>Asistente Chinfield</h3>
                <div class="chat-status">
                    <span class="status-indicator"></span>
                    <span>En lÃ­nea</span>
                </div>
            </div>
            <button class="chat-close" id="chatClose">âœ•</button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot welcome">
                <strong>Bienvenido al Asistente Virtual de Chinfield</strong><br/><br/>
                Puedo ayudarte con informaciÃ³n sobre nuestros productos:
                <ul>
                    <li>Dosificaciones y posologÃ­a</li>
                    <li>Indicaciones terapÃ©uticas</li>
                    <li>Contraindicaciones</li>
                    <li>VÃ­as de administraciÃ³n</li>
                </ul>
                Â¿En quÃ© puedo asistirte?
            </div>
        </div>
        
        <div class="chat-input-container">
            <input 
                type="text" 
                id="chatInput" 
                class="chat-input" 
                placeholder="Escriba su consulta..."
            />
            <button class="chat-send" id="chatSend">âž¤</button>
        </div>
    </div>

    <!-- Chat Button with Tooltip -->
    <div class="chat-button-container" id="chatButtonContainer">
        <div class="chat-tooltip" id="chatTooltip">Â¿En quÃ© puedo ayudarte?</div>
        <button class="chat-button" id="chatButton">
            <!-- Ãcono estilo Apple - minimalista y elegante -->
            <svg class="chinfield-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <!-- CÃ­rculo con gradiente suave -->
                <defs>
                    <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#D4243B"/>
                        <stop offset="100%" style="stop-color:#B01428"/>
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="50" fill="url(#redGradient)"/>
                <!-- Burbuja de chat elegante con curvas suaves -->
                <path d="M30 35 
                         C30 31, 33 28, 37 28
                         L63 28 
                         C67 28, 70 31, 70 35
                         L70 55
                         C70 59, 67 62, 63 62
                         L42 62
                         L34 72
                         L34 62
                         L37 62
                         C33 62, 30 59, 30 55
                         Z" 
                      fill="#ffffff"
                      opacity="0.95"/>
            </svg>
            <span class="chat-button-badge">1</span>
        </button>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://web-production-d0c48.up.railway.app';

        // State
        let chatOpen = false;
        let isWaitingResponse = false;

        // DOM Elements
        const chatWidget = document.getElementById('chatWidget');
        const chatButtonContainer = document.getElementById('chatButtonContainer');
        const chatButton = document.getElementById('chatButton');
        const chatTooltip = document.getElementById('chatTooltip');
        const chatClose = document.getElementById('chatClose');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        // Mostrar tooltip despuÃ©s de 3 segundos
        setTimeout(() => {
            if (!chatOpen) {
                chatTooltip.classList.add('visible');
            }
        }, 3000);

        // Event Listeners - Touch compatible
        chatButton.addEventListener('click', toggleChat);
        chatButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            toggleChat();
        }, { passive: false });

        chatClose.addEventListener('click', closeChat);
        chatClose.addEventListener('touchend', (e) => {
            e.preventDefault();
            closeChat();
        }, { passive: false });

        chatSend.addEventListener('click', sendMessage);
        chatSend.addEventListener('touchend', (e) => {
            e.preventDefault();
            sendMessage();
        }, { passive: false });

        chatInput.addEventListener('keypress', handleKeyPress);

        // Toggle chat
        function toggleChat() {
            chatOpen ? closeChat() : openChat();
        }

        function openChat() {
            if (chatOpen) return;
            chatOpen = true;
            chatWidget.classList.add('open');
            chatButtonContainer.style.display = 'none';
            chatTooltip.classList.remove('visible');
            
            setTimeout(() => {
                chatInput.focus();
                scrollToBottom();
            }, 300);

            const badge = document.querySelector('.chat-button-badge');
            if (badge) badge.style.display = 'none';
        }

        function closeChat() {
            if (!chatOpen) return;
            chatOpen = false;
            chatWidget.classList.remove('open');
            
            setTimeout(() => {
                chatButtonContainer.style.display = 'flex';
            }, 300);
        }

        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Format bot response
        function formatBotMessage(text) {
            text = text.replace(/\n/g, '<br/>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/### (.*?)(<br\/>|$)/g, '<strong>$1</strong>$2');
            return text;
        }

        // Send message
        async function sendMessage() {
            const message = chatInput.value.trim();
            
            if (!message || isWaitingResponse) return;
            
            chatInput.value = '';
            chatSend.disabled = true;
            addMessage(message, 'user');
            
            showTypingIndicator();
            isWaitingResponse = true;
            
            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                
                const data = await response.json();
                
                hideTypingIndicator();
                addMessage(data.answer, 'bot');
                
                if (data.needs_human) {
                    addHandoffMessage();
                }
                
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage(
                    'Disculpe, hubo un problema al procesar su consulta. Por favor contacte a info@chinfield.com',
                    'bot'
                );
            } finally {
                isWaitingResponse = false;
                chatSend.disabled = false;
                chatInput.focus();
            }
        }

        // Typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // Add message
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = formatBotMessage(text);
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Scroll to bottom
        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Handoff message
        function addHandoffMessage() {
            const handoffDiv = document.createElement('div');
            handoffDiv.className = 'message bot';
            handoffDiv.innerHTML = `
                <strong>ðŸ’¬ DerivaciÃ³n a Asesor TÃ©cnico</strong><br/><br/>
                Para consultas especÃ­ficas:<br/>
                ðŸ“§ info@chinfield.com<br/>
                ðŸ“ž +54 11 4762-5163
            `;
            chatMessages.appendChild(handoffDiv);
            scrollToBottom();
        }

        console.log('âœ… Chinfield Chat Widget v3.0 - Mobile First');
    </script>
</body>
</html>
