<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chinfield - Demo RAG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #chinfield-iframe {
            width: 100%;
            height: 100vh;
            border: none;
        }

        /* ============================================ */
        /* CHAT WIDGET - MOBILE FIRST (fullscreen)     */
        /* Estilo Apple - Suave y Elegante             */
        /* ============================================ */
        .chat-widget {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background: #ffffff;
            border-radius: 0;
            box-shadow: none;
            display: none;
            flex-direction: column;
            z-index: 10000;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.4s cubic-bezier(0.25, 0.1, 0.25, 1),
                        transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .chat-widget.open {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }

        .chat-widget.opening {
            display: flex;
        }

        /* Header - Estilo Apple */
        .chat-header {
            background: linear-gradient(180deg, #C8102E 0%, #A00D24 100%);
            color: #ffffff;
            padding: 20px 20px 18px;
            padding-top: calc(20px + env(safe-area-inset-top, 0px));
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        .chat-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(0, 0, 0, 0.1);
        }

        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .chat-avatar {
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .chat-avatar svg {
            width: 26px;
            height: 26px;
        }

        .chat-header-text h3 {
            font-size: 17px;
            font-weight: 600;
            margin-bottom: 2px;
            letter-spacing: -0.02em;
        }

        .chat-status {
            font-size: 13px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 400;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: #34D399;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(52, 211, 153, 0.6);
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: none;
            color: #ffffff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.25, 0.1, 0.25, 1);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .chat-close:active {
            transform: scale(0.95);
        }

        /* Messages Container */
        .chat-messages {
            flex: 1;
            padding: 20px 16px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            gap: 16px;
            -webkit-overflow-scrolling: touch;
            min-height: 0;
            background: #fafafa;
            scroll-behavior: smooth;
        }

        /* Message Bubbles - Estilo Apple */
        .message {
            padding: 14px 18px;
            border-radius: 20px;
            max-width: 85%;
            font-size: 15px;
            line-height: 1.55;
            word-wrap: break-word;
            position: relative;
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.4s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: linear-gradient(135deg, #C8102E 0%, #A00D24 100%);
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
            box-shadow: 0 2px 12px rgba(200, 16, 46, 0.2);
        }

        .message.bot {
            background: #ffffff;
            color: #1d1d1f;
            align-self: flex-start;
            border-bottom-left-radius: 6px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
        }

        .message.bot strong {
            color: #C8102E;
            font-weight: 600;
        }

        .message.welcome {
            background: #ffffff;
            padding: 18px 20px;
            max-width: 90%;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.06);
        }

        .message.welcome ul {
            margin-top: 14px;
            margin-left: 0;
            padding-left: 20px;
        }

        .message.welcome li {
            margin-bottom: 8px;
            color: #4b5563;
        }

        /* Typing Indicator - Elegante */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 16px 20px;
            background: #ffffff;
            border-radius: 20px;
            border-bottom-left-radius: 6px;
            width: fit-content;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            opacity: 0;
            transform: translateY(10px);
            animation: messageAppear 0.3s cubic-bezier(0.25, 0.1, 0.25, 1) forwards;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #C8102E;
            opacity: 0.4;
            animation: typingWave 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .typing-dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typingWave {
            0%, 60%, 100% { 
                transform: translateY(0);
                opacity: 0.4;
            }
            30% { 
                transform: translateY(-8px);
                opacity: 1;
            }
        }

        /* Input Container - Moderno */
        .chat-input-container {
            display: flex;
            gap: 12px;
            padding: 16px 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 8px));
            background: #ffffff;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            flex-shrink: 0;
        }

        .chat-input {
            flex: 1;
            padding: 14px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            font-family: inherit;
            -webkit-appearance: none;
            background: #f9fafb;
            transition: all 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .chat-input:focus {
            border-color: #C8102E;
            background: #ffffff;
            box-shadow: 0 0 0 3px rgba(200, 16, 46, 0.1);
        }

        .chat-input::placeholder {
            color: #9ca3af;
        }

        .chat-send {
            width: 50px;
            height: 50px;
            min-width: 50px;
            background: linear-gradient(135deg, #C8102E 0%, #A00D24 100%);
            border: none;
            border-radius: 50%;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s cubic-bezier(0.25, 0.1, 0.25, 1);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            -webkit-appearance: none;
            box-shadow: 0 4px 14px rgba(200, 16, 46, 0.3);
        }

        .chat-send:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(200, 16, 46, 0.4);
        }

        .chat-send:active {
            transform: scale(0.95);
        }

        .chat-send:disabled {
            background: #e5e7eb;
            box-shadow: none;
            cursor: not-allowed;
        }

        .chat-send svg {
            width: 22px;
            height: 22px;
            fill: #ffffff;
            transform: translateX(1px);
        }

        /* Chat Button Container */
        .chat-button-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Tooltip - Profesional y visible */
        .chat-tooltip {
            background: #ffffff;
            color: #374151;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1),
                        0 2px 6px rgba(0, 0, 0, 0.06);
            white-space: nowrap;
            opacity: 0;
            transform: translateX(8px);
            transition: all 0.3s ease;
            pointer-events: none;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .chat-tooltip.visible {
            opacity: 1;
            transform: translateX(0);
        }

        /* Chat Button - Profesional para laboratorio */
        .chat-button {
            width: 76px;
            height: 76px;
            background: #ffffff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12),
                        0 2px 6px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s ease;
            overflow: visible;
            padding: 16px;
        }

        .chat-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.14),
                        0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .chat-button:active {
            transform: scale(0.97);
            transition: all 0.1s ease;
        }

        .chinfield-logo {
            width: 46px;
            height: 46px;
            transition: transform 0.3s ease;
        }

        .chat-button:hover .chinfield-logo {
            transform: scale(1.03);
        }

        .chat-button-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            background: #C8102E;
            color: #ffffff;
            min-width: 24px;
            height: 24px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(200, 16, 46, 0.35);
            padding: 0 7px;
        }

        /* Demo Banner */
        .demo-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e3a5f 0%, #0f2744 100%);
            color: white;
            padding: 10px 24px;
            text-align: center;
            font-size: 13px;
            z-index: 9998;
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        /* ============================================ */
        /* DESKTOP (â‰¥768px)                            */
        /* ============================================ */
        @media (min-width: 768px) {
            .chat-widget {
                top: auto;
                left: auto;
                bottom: 100px;
                right: 24px;
                width: 400px;
                height: 620px;
                max-height: calc(100vh - 140px);
                border-radius: 24px;
                box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15),
                            0 4px 12px rgba(0, 0, 0, 0.05);
            }

            .chat-header {
                border-radius: 24px 24px 0 0;
            }

            .chat-close:hover {
                background: rgba(255, 255, 255, 0.25);
            }

            .chat-messages {
                padding: 24px 20px;
            }

            .chat-input-container {
                border-radius: 0 0 24px 24px;
            }

            .chat-button {
                width: 72px;
                height: 72px;
                padding: 14px;
            }

            .chinfield-logo {
                width: 42px;
                height: 42px;
            }
        }
    </style>
</head>
<body>
    <!-- Demo Banner -->
    <div class="demo-banner">
        <strong>DEMO TÃ‰CNICA</strong> - Asistente Virtual RAG para Chinfield
    </div>

    <!-- Chinfield Website Iframe -->
    <iframe 
        id="chinfield-iframe" 
        src="https://chinfield.com"
        title="Chinfield Website"
        style="margin-top: 40px; height: calc(100vh - 40px);">
    </iframe>

    <!-- Chat Widget -->
    <div id="chatWidget" class="chat-widget">
        <div class="chat-header">
            <div class="chat-header-info">
                <div class="chat-avatar">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 5C13.66 5 15 6.34 15 8C15 9.66 13.66 11 12 11C10.34 11 9 9.66 9 8C9 6.34 10.34 5 12 5ZM12 19.2C9.5 19.2 7.29 17.92 6 15.98C6.03 13.99 10 12.9 12 12.9C13.99 12.9 17.97 13.99 18 15.98C16.71 17.92 14.5 19.2 12 19.2Z" fill="white"/>
                    </svg>
                </div>
                <div class="chat-header-text">
                    <h3>Asistente Chinfield</h3>
                    <div class="chat-status">
                        <span class="status-indicator"></span>
                        <span>En lÃ­nea</span>
                    </div>
                </div>
            </div>
            <button class="chat-close" id="chatClose">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot welcome">
                <strong>Â¡Hola! Soy el Asistente Chinfield</strong><br><br>
                Puedo ayudarte con informaciÃ³n sobre nuestros productos veterinarios:
                <ul>
                    <li>Dosificaciones y posologÃ­a</li>
                    <li>Indicaciones terapÃ©uticas</li>
                    <li>Contraindicaciones</li>
                    <li>VÃ­as de administraciÃ³n</li>
                </ul>
                <br>Â¿En quÃ© puedo asistirte?
            </div>
        </div>
        
        <div class="chat-input-container">
            <input 
                type="text" 
                id="chatInput" 
                class="chat-input" 
                placeholder="EscribÃ­ tu consulta..."
            />
            <button class="chat-send" id="chatSend">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- Chat Button with Tooltip -->
    <div class="chat-button-container" id="chatButtonContainer">
        <div class="chat-tooltip" id="chatTooltip">Â¿En quÃ© puedo ayudarte?</div>
        <button class="chat-button" id="chatButton">
            <svg class="chinfield-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="redGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#D4243B"/>
                        <stop offset="100%" style="stop-color:#B01428"/>
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="50" fill="url(#redGradient)"/>
                <path d="M30 35 
                         C30 31, 33 28, 37 28
                         L63 28 
                         C67 28, 70 31, 70 35
                         L70 55
                         C70 59, 67 62, 63 62
                         L42 62
                         L34 72
                         L34 62
                         L37 62
                         C33 62, 30 59, 30 55
                         Z" 
                      fill="#ffffff"
                      opacity="0.95"/>
            </svg>
            <span class="chat-button-badge">1</span>
        </button>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://web-production-d0c48.up.railway.app';

        // State
        let chatOpen = false;
        let isWaitingResponse = false;

        // DOM Elements
        const chatWidget = document.getElementById('chatWidget');
        const chatButtonContainer = document.getElementById('chatButtonContainer');
        const chatButton = document.getElementById('chatButton');
        const chatTooltip = document.getElementById('chatTooltip');
        const chatClose = document.getElementById('chatClose');
        const chatInput = document.getElementById('chatInput');
        const chatSend = document.getElementById('chatSend');
        const chatMessages = document.getElementById('chatMessages');

        // Mostrar tooltip despuÃ©s de 3 segundos (primera vez)
        setTimeout(() => {
            if (!chatOpen) {
                chatTooltip.classList.add('visible');
            }
        }, 3000);

        // Tooltip en hover (siempre)
        chatButton.addEventListener('mouseenter', () => {
            if (!chatOpen) {
                chatTooltip.classList.add('visible');
            }
        });

        chatButton.addEventListener('mouseleave', () => {
            chatTooltip.classList.remove('visible');
        });

        // Event Listeners
        chatButton.addEventListener('click', toggleChat);
        chatButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            toggleChat();
        }, { passive: false });

        chatClose.addEventListener('click', closeChat);
        chatClose.addEventListener('touchend', (e) => {
            e.preventDefault();
            closeChat();
        }, { passive: false });

        chatSend.addEventListener('click', sendMessage);
        chatSend.addEventListener('touchend', (e) => {
            e.preventDefault();
            sendMessage();
        }, { passive: false });

        chatInput.addEventListener('keypress', handleKeyPress);

        // Toggle chat
        function toggleChat() {
            chatOpen ? closeChat() : openChat();
        }

        function openChat() {
            if (chatOpen) return;
            chatOpen = true;
            
            // Ocultar tooltip
            chatTooltip.classList.remove('visible');
            
            // Primero mostrar con display, luego animar
            chatWidget.classList.add('opening');
            chatButtonContainer.style.display = 'none';
            
            // Trigger reflow para que la animaciÃ³n funcione
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    chatWidget.classList.add('open');
                    chatWidget.classList.remove('opening');
                });
            });
            
            setTimeout(() => {
                chatInput.focus();
            }, 400);

            const badge = document.querySelector('.chat-button-badge');
            if (badge) badge.style.display = 'none';
        }

        function closeChat() {
            if (!chatOpen) return;
            chatOpen = false;
            
            chatWidget.classList.remove('open');
            
            setTimeout(() => {
                chatWidget.style.display = 'none';
                chatButtonContainer.style.display = 'flex';
                chatWidget.style.display = '';
            }, 400);
        }

        // Handle enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Format bot response
        function formatBotMessage(text) {
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/### (.*?)(<br>|$)/g, '<strong>$1</strong>$2');
            return text;
        }

        // Send message
        async function sendMessage() {
            const message = chatInput.value.trim();
            
            if (!message || isWaitingResponse) return;
            
            chatInput.value = '';
            chatSend.disabled = true;
            addMessage(message, 'user');
            
            showTypingIndicator();
            isWaitingResponse = true;
            
            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                
                const data = await response.json();
                
                hideTypingIndicator();
                addMessage(data.answer, 'bot');
                
                if (data.needs_human) {
                    addHandoffMessage();
                }
                
            } catch (error) {
                console.error('Error:', error);
                hideTypingIndicator();
                addMessage(
                    'DisculpÃ¡, hubo un problema al procesar tu consulta. Por favor contactÃ¡ a info@chinfield.com',
                    'bot'
                );
            } finally {
                isWaitingResponse = false;
                chatSend.disabled = false;
                chatInput.focus();
            }
        }

        // Typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typing-indicator';
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            chatMessages.appendChild(typingDiv);
            scrollToBottom();
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // Add message - scroll al inicio del mensaje nuevo
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = formatBotMessage(text);
            } else {
                messageDiv.textContent = text;
            }
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll al inicio del nuevo mensaje (no al final)
            requestAnimationFrame(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        // Scroll to bottom (para typing indicator)
        function scrollToBottom() {
            requestAnimationFrame(() => {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }

        // Handoff message
        function addHandoffMessage() {
            const handoffDiv = document.createElement('div');
            handoffDiv.className = 'message bot';
            handoffDiv.innerHTML = `
                <strong>Â¿NecesitÃ¡s mÃ¡s ayuda?</strong><br><br>
                Para consultas especÃ­ficas contactÃ¡ a nuestro equipo:<br><br>
                ðŸ“§ info@chinfield.com<br>
                ðŸ“ž +54 11 4762-5163
            `;
            chatMessages.appendChild(handoffDiv);
            
            requestAnimationFrame(() => {
                handoffDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            });
        }

        console.log('âœ… Chinfield Chat Widget v4.0 - Apple Style');
    </script>
</body>
</html>
